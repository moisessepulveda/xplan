version: "3.8"

services:
  # =============================================================================
  # Laravel Octane - Main Application (3 replicas)
  # =============================================================================
  app:
    image: xplan:${IMAGE_TAG:-latest}
    command: octane
    ports:
      - "8080:8000"
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
        window: 120s
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: ${APP_KEY}
      APP_URL: ${APP_URL}
      LOG_CHANNEL: stderr
      LOG_LEVEL: warning
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/html/database/database.sqlite
      CACHE_DRIVER: file
      SESSION_DRIVER: file
      QUEUE_CONNECTION: database
      MAIL_MAILER: ${MAIL_MAILER:-log}
      MAIL_HOST: ${MAIL_HOST:-}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME:-}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-XPlan}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - ${SQLITE_DATA_PATH}:/var/www/html/database
      - ${STORAGE_PRIVATE_PATH}:/var/www/html/storage/app/private
      - ${STORAGE_LOGS_PATH}:/var/www/html/storage/logs
    networks:
      - xplan_network
    healthcheck:
      test: ["CMD", "curl", "-f", "-s", "http://127.0.0.1:8000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # =============================================================================
  # Queue Worker (1 replica with supervisor auto-restart)
  # =============================================================================
  queue:
    image: xplan:${IMAGE_TAG:-latest}
    command: queue
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: ${APP_KEY}
      APP_URL: ${APP_URL}
      LOG_CHANNEL: stderr
      LOG_LEVEL: warning
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/html/database/database.sqlite
      CACHE_DRIVER: file
      QUEUE_CONNECTION: database
      MAIL_MAILER: ${MAIL_MAILER:-log}
      MAIL_HOST: ${MAIL_HOST:-}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME:-}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-XPlan}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - ${SQLITE_DATA_PATH}:/var/www/html/database
      - ${STORAGE_PRIVATE_PATH}:/var/www/html/storage/app/private
      - ${STORAGE_LOGS_PATH}:/var/www/html/storage/logs
    networks:
      - xplan_network
    depends_on:
      - app

  # =============================================================================
  # Scheduler (1 replica with supervisor auto-restart)
  # =============================================================================
  scheduler:
    image: xplan:${IMAGE_TAG:-latest}
    command: scheduler
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 64M
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: ${APP_KEY}
      APP_URL: ${APP_URL}
      LOG_CHANNEL: stderr
      LOG_LEVEL: warning
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/html/database/database.sqlite
      CACHE_DRIVER: file
      QUEUE_CONNECTION: database
    volumes:
      - ${SQLITE_DATA_PATH}:/var/www/html/database
      - ${STORAGE_PRIVATE_PATH}:/var/www/html/storage/app/private
      - ${STORAGE_LOGS_PATH}:/var/www/html/storage/logs
    networks:
      - xplan_network
    depends_on:
      - app

# =============================================================================
# Networks
# =============================================================================
networks:
  xplan_network:
    driver: overlay
    attachable: true
